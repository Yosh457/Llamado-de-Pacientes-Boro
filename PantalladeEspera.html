<!-- 
  Código para Shortcoder: Pantalla de Espera V3
  1. Se reemplaza Llamado Actual por el tipo de llamado que se escoge del formulario.
  2. Se mantiene el tiempo de desaparación del llamado actual por 2 minutos.
  3. Mejoras de diseño para que sea adaptable en pantallas de los recintos (Televisores)
-->
<div id="pantalla-app-container">
    <style>
        /* [Los estilos base se mantienen igual] */
        #pantalla-app-container, #pantalla-app-container * {
            margin: 0; padding: 0; border: 0; font: inherit;
            vertical-align: baseline; box-sizing: border-box; line-height: 1.5;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        #pantalla-app-container {
            font-family: 'Roboto', sans-serif !important;
            background-color: #0f172a !important; color: white !important;
            height: 100vh; width: 100vw; position: fixed;
            top: 0; left: 0; z-index: 99999; overflow: hidden;
            display: none; 
        }
        #pantalla-app-container.ready { display: flex; flex-direction: column; }
        #pantalla-app-container .screen-layout { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #pantalla-app-container .screen-header {
            width: 100%; padding: 1rem 2rem; display: flex;
            justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        #pantalla-app-container .screen-header img { max-height: 80px; width: auto; }
        #pantalla-app-container .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; padding: 2rem 1rem; overflow-y: auto;
            justify-content: center;
        }
        #pantalla-app-container .footer-history {
            flex-shrink: 0; background-color: #1e293b;
            padding: 1rem 2rem; width: 100%;
        }
        #pantalla-app-container h1, #pantalla-app-container h2, #pantalla-app-container p, #pantalla-app-container div {
            font-family: 'Roboto', sans-serif !important; color: inherit; font-weight: normal;
        }
        
        #pantalla-app-container #call-type-title {
            font-size: 3rem !important; font-weight: 900 !important;
            text-transform: uppercase !important; letter-spacing: 0.05em !important;
            margin-bottom: 1rem !important; text-align: center;
            color: #f59e0b !important; /* Color ámbar para destacar */
        }

        #pantalla-app-container .history-title {
            font-size: 2.5rem !important; font-weight: 700 !important;
            text-transform: uppercase !important; letter-spacing: 0.1em !important;
            margin-bottom: 1rem !important; color: #94a3b8 !important; text-align: center;
        }
        #pantalla-app-container #start-overlay {
            position: absolute; inset: 0; background-color: rgba(15, 23, 42, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; cursor: pointer;
        }
        #pantalla-app-container #start-overlay h2 {
            font-size: 3.75rem !important; font-weight: 700 !important; color: white !important; margin-bottom: 1rem !important;
        }
        #pantalla-app-container #start-overlay p { font-size: 1.5rem !important; color: #cbd5e1 !important; margin-bottom: 2rem !important; }
        #pantalla-app-container .current-call-item {
            display: flex !important; flex-direction: column;
            align-items: center !important; width: 100%; max-width: 100rem;
            margin-left: auto; margin-right: auto; background: #ffffff !important; border-radius: 1rem !important;
            padding: 2rem 1.5rem 1.5rem 1.5rem !important; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25) !important;
            transform: scale(0.95) translateY(20px); opacity: 0;
            animation: pantallaFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes pantallaFadeIn { to { transform: scale(1) translateY(0); opacity: 1; } }
        #pantalla-app-container .call-main-info {justify-content: space-between; width: 100%; }
        #pantalla-app-container .current-call-item .patient-name { font-size: 5rem !important; font-weight: 900 !important; color: #1e293b !important; text-transform: uppercase; }
        #pantalla-app-container .current-call-item .box-name { font-size: 5.5rem !important; font-weight: 700 !important; color: #0d9488 !important; }
        #pantalla-app-container .current-call-item .call-timestamp {
            width: 100%; text-align: center; margin-top: 0.5rem;
            font-size: 2rem !important; font-weight: 700 !important; color: #94a3b8 !important;
        }
        
        #pantalla-app-container .history-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center; width: 100%; }
        #pantalla-app-container .history-group {
            background: #1e293b !important; border-left: 5px solid #0d9488 !important;
            padding: 1rem !important; border-radius: 0.5rem !important;
            display: flex; flex-direction: column;
        }
        #pantalla-app-container .history-group .patient-name-history { font-weight: 700 !important; text-transform: uppercase; font-size: 2.125rem !important; color: white !important; }
        #pantalla-app-container .history-group .box-name-history { font-size: 1.5rem !important; color: #cbd5e1 !important; margin-top: 0.25rem !important; }
        #pantalla-app-container .history-group .call-timestamp-history { margin-top: 0.5rem; font-size: 1rem !important; color: #64748b !important; font-weight: 700 !important; }
        
        #pantalla-app-container .waiting-message { text-align: center; color: #94a3b8 !important; }
        #pantalla-app-container .waiting-message .waiting-text { font-size: 3.5rem !important; font-weight: 700 !important; color: #e2e8f0 !important; }
        #pantalla-app-container .waiting-message .center-name { font-size: 7.5rem !important; font-weight: 900 !important; color: white !important; margin-top: 0.5rem; }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <div id="start-overlay">
        <h2>Sala de Espera</h2>
        <p>Haga clic aquí para iniciar la pantalla</p>
        <svg style="width: 6rem; height: 6rem; color: white;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 0 1 0 .656l-5.603 3.113a.375.375 0 0 1-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112Z" />
        </svg>
    </div>

    <div class="screen-layout">
        <header class="screen-header">
            <img src="https://mahosalud.cl/wp-content/uploads/2024/12/Logo-Red-APS.png" alt="Logo Red APS">
            <img src="https://mahosalud.cl/wp-content/uploads/2024/09/Maho-Multicultural-y-DEPSA-02.png" alt="Logo Maho Multicultural y DEPSA">
        </header>
        <div class="main-content">
            <h1 id="call-type-title"></h1> 
            <div id="current-calls-list" style="width:100%; max-width: 100rem; display:flex; flex-direction:column; gap:1rem; text-align: center;">
                </div>
        </div>
        <div class="footer-history">
            <h2 class="history-title">Últimos Llamados</h2>
            <div id="history-list" class="history-grid"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, limit, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "Aqui_va_tu_api_key",
            authDomain: "Aqui_va_tu_auth_domain",
            projectId: "Aqui_va_tu_project_id",
            storageBucket: "Aqui_va_tu_storage_bucket",
            messagingSenderId: "Aqui_va_tu_messaging_sender_id",
            appId: "Aqui_va_tu_app_id"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        (function() {
            const container = document.getElementById('pantalla-app-container');
            if (!container) return;
            
            setTimeout(() => { document.body.appendChild(container); container.classList.add('ready'); }, 0);

            const callTypeTitleEl = container.querySelector('#call-type-title');
            const currentCallsListEl = container.querySelector('#current-calls-list');
            const historyListEl = container.querySelector('#history-list');
            const startOverlay = container.querySelector('#start-overlay');
            
            let lastCallTimestamp = null;
            let audioInitialized = false;
            let isAnnouncing = false;
            const announcementQueue = [];
            let selectedVoice = null;
            let clearCallTimer = null;
            let synth = null;

            function formatTimestamp(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }

            function loadAndSetVoice() {
                return new Promise((resolve) => {
                    const setVoices = () => {
                        const voices = speechSynthesis.getVoices();
                        if (voices.length > 0) {
                            const voicePriority = ['es-CL', 'es-MX', 'es-US', 'es-AR', 'es-ES'];
                            for (const lang of voicePriority) {
                                selectedVoice = voices.find(voice => voice.lang === lang);
                                if (selectedVoice) break;
                            }
                            if (!selectedVoice) selectedVoice = voices.find(voice => voice.lang.startsWith('es-'));
                            resolve();
                        }
                    };
                    if (speechSynthesis.getVoices().length > 0) setVoices();
                    else speechSynthesis.onvoiceschanged = setVoices;
                });
            }

            function speakUtteranceQueue(utterances, onComplete) {
                if (!audioInitialized || !('speechSynthesis' in window) || utterances.length === 0) {
                    if (onComplete) onComplete(); return;
                }
                window.speechSynthesis.cancel();
                let i = 0;
                function speakNext() {
                    if (i < utterances.length) {
                        if (selectedVoice) utterances[i].voice = selectedVoice;
                        utterances[i].onend = () => { i++; speakNext(); };
                        window.speechSynthesis.speak(utterances[i]);
                    } else if (onComplete) onComplete();
                }
                speakNext();
            }

            function startAnnouncementSequence(announcement, onComplete) {
                if (!announcement || announcement.type !== 'call') {
                    if(onComplete) onComplete(); return;
                }

                const callTexts = {
                    primer: 'Primer llamado para',
                    segundo: 'Segundo llamado para',
                    tercer: 'Tercer y último llamado para'
                };
                const callText = callTexts[announcement.data.tipo_llamado] || 'Llamado para';

                const utterances = announcement.data.pacientes.map(p => {
                    const u = new SpeechSynthesisUtterance(`${callText} ${p.nombre}. Diríjase al ${p.box}.`);
                    u.lang = 'es-CL'; u.rate = 0.9;
                    return u;
                });

                // CAMBIO: La voz ahora se anuncia una sola vez.
                const repeatCount = 1;
                let count = 0;

                function announce() {
                    if (count++ >= repeatCount) { 
                        if (onComplete) onComplete(); 
                        return;
                    }
                    speakUtteranceQueue([...utterances], () => setTimeout(announce, 3000));
                }

                if (audioInitialized && synth) {
                    synth.triggerAttackRelease("G5", "8n", Tone.now());
                    synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.3);
                }
                
                setTimeout(() => { announce(); }, 1500);
            }
            
            function processQueue() {
                if (isAnnouncing || announcementQueue.length === 0) return;
                
                isAnnouncing = true;
                const currentAnnouncement = announcementQueue.shift();
                
                updateCurrentCallDisplay(currentAnnouncement.data);
                if (currentAnnouncement.type === 'call') {
                    updateHistoryDisplay(currentAnnouncement.data.timestamp);
                }
                
                startAnnouncementSequence(currentAnnouncement, () => {
                    isAnnouncing = false;
                    processQueue();
                });
            }
            
            function updateCurrentCallDisplay(currentCall) {
                currentCallsListEl.innerHTML = "";
                if (currentCall?.pacientes && currentCall.pacientes.length > 0) {
                    const callTitles = {
                        primer: 'Primer Llamado',
                        segundo: 'Segundo Llamado',
                        tercer: 'Tercer y Último Llamado'
                    };
                    callTypeTitleEl.textContent = callTitles[currentCall.tipo_llamado] || 'Llamado Actual';
                    callTypeTitleEl.style.display = 'block';

                    const formattedTime = formatTimestamp(currentCall.timestamp);
                    currentCall.pacientes.forEach((n, c) => {
                        const s = document.createElement("div");
                        s.className = "current-call-item";
                        s.style.animationDelay = `${100 * c}ms`;
                        s.innerHTML = `<div class="call-main-info"><p class="patient-name">${n.nombre}</p><p class="box-name">${n.box}</p></div><div class="call-timestamp">${formattedTime}</div>`;
                        currentCallsListEl.appendChild(s);
                    });
                } else {
                    showWaitingMessage();
                }
            }
            
            function showWaitingMessage() {
                callTypeTitleEl.style.display = 'none';
                currentCallsListEl.innerHTML = `
                    <div class="waiting-message">
                        <div class="waiting-text">Recuerde llegar 15 minutos antes de su cita.</div>
                        <div class="waiting-text">No olvides registrar tu llegada en SOME.</div>
                        <div class="center-name">CECOSF El Boro</div>
                    </div>
                `;
            }
            
            async function updateHistoryDisplay(currentCallTimestamp) {
                const q = query(collection(db, "registros_de_llamados"), orderBy("timestamp", "desc"), limit(5));
                const querySnapshot = await getDocs(q);
                
                historyListEl.innerHTML = "";
                const historyDocs = [];
                
                querySnapshot.forEach(doc => {
                    if (doc.data().timestamp !== currentCallTimestamp) {
                        historyDocs.push(doc.data());
                    }
                });

                historyDocs.slice(0, 4).forEach(callData => {
                    const c = document.createElement("div");
                    c.className = "history-group";
                    const s = callData.pacientes.map(l => `<div class="patient-name-history">${l.nombre}</div>`).join("");
                    const formattedTimeHistory = formatTimestamp(callData.timestamp);
                    c.innerHTML = `<div>${s}</div><div class="box-name-history">${callData.pacientes[0].box}</div><div class="call-timestamp-history">${formattedTimeHistory}</div>`;
                    historyListEl.appendChild(c);
                });
            }
            
            function handleExpiration() {
                clearTimeout(clearCallTimer);
                const TWO_MINUTES = 2 * 60 * 1000;
                
                clearCallTimer = setTimeout(async () => {
                    try {
                        const stateDocRef = doc(db, "boro_llamados", "estado_actual");
                        await setDoc(stateDocRef, { llamadaGrupalActual: null });
                    } catch (error) {
                        console.error("Error al limpiar el estado actual:", error);
                    }
                }, TWO_MINUTES);
            }

            const stateDocRef = doc(db, "boro_llamados", "estado_actual");
            onSnapshot(stateDocRef, (doc) => {
                if (!doc.exists()) return;
                const data = doc.data();
                const newCall = data.llamadaGrupalActual;

                if (newCall && newCall.timestamp !== lastCallTimestamp) {
                    lastCallTimestamp = newCall.timestamp;
                    announcementQueue.push({ type: 'call', data: newCall });
                    processQueue();
                    handleExpiration();
                } else if (!newCall) {
                    showWaitingMessage();
                    updateHistoryDisplay(null);
                }
            });

            startOverlay.addEventListener("click", async () => {
                startOverlay.style.display = "none";
                audioInitialized = true;
                
                await Tone.start();
                synth = new Tone.Synth().toDestination();

                await loadAndSetVoice();
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(" "));
                }
                showWaitingMessage();
                updateHistoryDisplay(null);
            }, { once: true });
            
            showWaitingMessage();
        })();
    </script>
</div>
